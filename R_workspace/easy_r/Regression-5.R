# 회귀진단(Regression Diagnostics)

# 회귀분석의 통계적 가정(Statistical Assumptions)의 
# 충족여부 확인 통해, 회귀분석결과에 대한 신뢰성 확보.

# (1) 회귀분석을 통한, 모델의 적합화(Model fitting)은
#     첫번째 단계에 불과.
# (2) 회귀분석의 가정을 검정하는 방법이 습득되어야 만 한다.


# 회귀진단(Regression Diagnostics) 수행
# lm()함수로 적합화된 모델과, summary()함수로 확인된
# 회귀모델과 계수의 유의성 검정의 결과는, 결코
# 회귀분석의 가정을 설명하지 않습니다.
# 때문에., 회귀진단이 별도로 수행되어야 합니다.

df_states <- 
  as.data.frame(
    state.x77[ , 
               c('Murder', 'Population', 'Illiteracy', 'Income', 'Frost')
               ]
  )
View(df_states) 

# 다중선형회귀분석수행
fit <- lm(Murder ~ Population + Illiteracy + Income + Frost, data = df_states)
#fit <- lm(Murder ~ . , data = df_states) # NOT recommended.

fit

summary(fit)


#---------------------------------------------
# 회귀진단 수행 방법 - 1
#---------------------------------------------
dev.off()

# 그림영역에, 지정된 격자구조를 만듦
par(mfrow=c(2,2)) # 2 x 2 격자구조

# 적합성 진단플롯 4개를 동시에 보여줌
plot(fit)

# 적합성 진단플롯 4개를 개별적으로 선택하여 보여줌
dev.off() # Plot 영역초기화

plot(fit, which = 1)
plot(fit, which = 2)
plot(fit, which = 3)
plot(fit, which = 4)

par(mfrow=c(1,1)) # 1 x 1 격자구조(default)



#---------------------------------------------
# 회귀진단 수행 방법 - 2 (향상된 접근법)
#---------------------------------------------
# {car} 패키지 안에, 회귀분석 가정을 판단할 수 있는
# 유용한 함수들이 있습니다.
# {gvlma} 패키지도 유용하다.


# *********************************
# (1) 정규성 가정 진단
# *********************************
dev.off() # Plot 영역초기화

dev.off()

library(car)
qqPlot(
  fit,
  labels=row.names(df_states),
  simulate = T,
  main = '- Main Title -'
)


# *********************************
# (2) 독립성 가정 진단
# *********************************
# 대상: 잔차의 독립성을 보는 것이다!!!
# 잔차의 독립성 검정기법 --> Dubin-Watson Test 이용
# durbinWatsonTest 검정의 통계적 가설은 아래와 같음:
#    H0: 모상관계수(rho)는 == 0이다. 
#         -> 잔차값들이 서로간에 자기상관성이 없음 의미
#         -> 잔차는 독립이다
#    H1: NOT H0
durbinWatsonTest(fit)


# *********************************
# (3) 선형성 가정 진단
# *********************************
# 독립변수와 종속변수 간의 관계가 선형적인지 진단
# 실제 진단 대상은 바로 잔차이다.

# 선형성 가정을 위배하는 경우에는,
# (1) 현재의 fitted model(회귀모형)은 
#     적합하지 않는 것으로 간주하고, 
# (2) 다항회귀같은 곡선적 요인을 추가하거나
# (3) 하나 또는 둘 이상의 독립변수들을 소위 "변환" 해야 함
library(car)

crPlots(fit)


# *********************************
# (4) 등분산성 진단
# *********************************
# ncvTest{car} 검정함수 이용
# 통계적 가설: 
#    H0: homoscedasticity   (등분산성)
#    H1: heteroscedasticity (이분산성)

library(car)
ncvTest(fit)


# 오차등분산성을 평가하는 Spread-Level Plot
# -----------------------------------------
# 점들이 가장 적합한 수평선 주위에 무작위적인 수평적 무리를
# 형성하면, 등분산성을 인정할 수 있다
#
# 만일 이분산성을 가지게 된다면,
# 수평이 아닌 선(곡선등)이 나타나게 됨
#
# 플롯의 결과는 위의 ncvTest{car} 검정결과와 같음
spreadLevelPlot(fit)


# 위 함수가 제안하는 지수변환값(power transformation)은
# 아래와 같이 변환식을 종속변수에 적용합니다.
# λ 값에 따라 아래와 같이 변환식을 적용합니다.
# ----------------------------------------------------------------
# λ   -2      -1     -0.5      0      0.5      1               2
# ----------------------------------------------------------------
# 식  1/Y^2   1/Y  1/sqrt(Y) log(Y)  sqrt(Y) Y(변환필요없음)  Y^2
#
# 종속변수 Y의 값이 비율(rate)일 때에는, 일반적으로 "로짓변환"
# (logit transformation) 하는 경우가 많이 존재합니다.
# 
#  Logit transformation = ln( Y / 1 - Y )



# *********************************
# 선형회귀모델의 가정에 대한 옴니버스 검정
# *********************************

library(gvlma)

gvlma(fit)
